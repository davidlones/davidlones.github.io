
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quantum Corkboard v3</title>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand:wght@400&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  html, body { height:100%; margin:0; }
  body {
    background: radial-gradient(1200px 600px at 50% 0%, #a86f52 0%, #915f48 35%, #7a503d 100%);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center; padding:12px;
  }
  #wrap {
    width: min(1200px, 96vw);
    height: min(820px, 92vh);
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 24px 60px rgba(0,0,0,.45);
  }
  .bar { position:absolute; top:10px; left:10px; display:flex; gap:8px; z-index:10; }
  .btn {
    background:#111827; color:#fff; border:none; border-radius:8px; padding:8px 10px;
    font-weight:700; cursor:pointer; font-size:12px; box-shadow: 0 4px 14px rgba(0,0,0,.25);
  }
  .btn.secondary { background:#334155; }
  canvas { width:100%; height:100%; display:block; background:#b98a60; }
  .hint {
    position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.65); padding:6px 10px; border-radius:8px; font-size:12px;
    color:#1f2937; backdrop-filter: blur(4px);
  }
</style>
</head>
<body>
  <div id="wrap">
    <div class="bar">
      <button class="btn" id="newNote">+ Note</button>
      <button class="btn" id="newTask">+ Task</button>
      <button class="btn secondary" id="toggleStrings">Strings: on</button>
      <button class="btn secondary" id="exportPNG">Export PNG</button>
      <button class="btn secondary" id="save">Save</button>
      <button class="btn secondary" id="reset">Reset</button>
    </div>
    <canvas id="board" width="1200" height="820"></canvas>
    <div class="hint">Drag notes. Double-click to edit. Tap task text to edit. Timer: Start/Stop; rightâ€‘click to reset; presets on the left. Pauses when hidden.</div>
  </div>

<script>
// ===== Setup
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const TAU = Math.PI*2;
const W = canvas.width, H = canvas.height;
const isTouch = 'ontouchstart' in window;

// ===== State
const DEFAULT = {
  date: { title: "November 4", subtitle: "Tuesday 2025" },
  dateCard: { x: 430, y: 110, w: 360, h: 110 },
  notes: [
    { id:'sale',  x: 80,  y: 140, w:280, h:170, title:"Sale?", content:"", color:"#F7F0B6" },
    { id:'fall',  x: 880, y: 160, w:280, h:170, title:"", content:"Fall decorations\nBring down\nfrom attic", color:"#F7F0B6" },
    { id:'edit',  x: 90,  y: 500, w:300, h:190, title:"", content:"(doubleâ€‘click to edit)", color:"#F7F0B6" },
    { id:'offer', x: 880, y: 520, w:280, h:170, title:"Offer\naccepted?", content:"", color:"#F7F0B6" }
  ],
  tasksCard: { x: 430, y: 340, w: 360, h: 300 },
  tasks: [
    { text:"DVDs boxed up to take to Half-Price", done:false },
    { text:"Clean kitchen", done:false },
    { text:"Take out trash", done:false },
    { text:"Goal of the week: clear living room to clean carpet", done:false }
  ],
  timer: { seconds: 5*60, running:false },
  stringsOn: true,
  // layout for timer widget on left
  timerRect: { x: 18, y: 210, w: 170, h: 250 }
};
const state = load() || DEFAULT;

// ===== Persistence
function save(){ localStorage.setItem('quantum_v3', JSON.stringify(state)); }
function load(){ try{ return JSON.parse(localStorage.getItem('quantum_v3')); }catch{ return null; } }
document.getElementById('save').onclick = save;
document.getElementById('reset').onclick = () => { localStorage.removeItem('quantum_v3'); location.reload(); };
document.getElementById('newNote').onclick = () => { const id='n'+Math.random().toString(36).slice(2,7); state.notes.push({id,x:140,y:220,w:280,h:170,title:'',content:'New note',color:'#F7F0B6'}); save(); };
document.getElementById('newTask').onclick = () => { state.tasks.push({text:'New taskâ€¦', done:false}); save(); };
document.getElementById('toggleStrings').onclick = (e)=>{ state.stringsOn=!state.stringsOn; e.target.textContent='Strings: '+(state.stringsOn?'on':'off'); };

// ===== Drawing helpers
function roundedRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function drawPin(cx,cy){
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=8; ctx.shadowOffsetY=3;
  const g=ctx.createRadialGradient(cx-3,cy-3,1,cx,cy,11);
  g.addColorStop(0,'#d64545'); g.addColorStop(1,'#a83232');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,11,0,TAU); ctx.fill();
  ctx.shadowBlur=0; ctx.fillStyle='#812524'; ctx.fillRect(cx-1, cy+9, 2, 7);
  ctx.restore();
}
function cork(){
  // dark frame edges + inner cork
  ctx.fillStyle='#a26746'; ctx.fillRect(0,0,W,H);
  // inner inset
  ctx.save();
  roundedRect(20,20,W-40,H-40,18); ctx.clip();
  // wood/cardboard tint
  ctx.fillStyle='#c69c6d'; ctx.fillRect(0,0,W,H);
  // fine speckles
  ctx.globalAlpha=.12;
  for(let i=0;i<1400;i++){ const x=Math.random()*W, y=Math.random()*H, r=Math.random()*1.3;
    ctx.fillStyle='rgba(0,0,0,.85)'; ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill(); }
  ctx.globalAlpha = .06;
  for(let i=0;i<400;i++){ const x=Math.random()*W, y=Math.random()*H, r=1.5+Math.random()*2.2;
    ctx.fillStyle='rgba(255,255,255,1)'; ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill(); }
  ctx.globalAlpha=1;
  ctx.restore();
  // inner rim shadow
  ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=18; roundedRect(20,20,W-40,H-40,18); ctx.stroke();
}
function drawNote(n){
  ctx.save();
  // paper
  ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=16; ctx.shadowOffsetX=3; ctx.shadowOffsetY=8;
  ctx.fillStyle=n.color; roundedRect(n.x,n.y,n.w,n.h,10); ctx.fill();
  ctx.shadowBlur=0;
  // pin top center
  drawPin(n.x+n.w/2, n.y-6);
  // text
  ctx.fillStyle='#1f2937';
  ctx.font='28px "Patrick Hand", cursive'; // title vibe
  let y=n.y+40;
  if(n.title){ wrapText(n.title, n.x+22, y, n.w-40, 34, true); y+=32; }
  ctx.font='22px "Patrick Hand", cursive';
  if(n.content){ drawMultiline(n.content, n.x+22, y, 26); }
  ctx.restore();
}
function wrapText(text, x, y, maxWidth, lineHeight, underline=false){
  const words = text.split(' '); let line=''; for(let i=0;i<words.length;i++){
    const test = line + words[i] + ' '; if(ctx.measureText(test).width > maxWidth && i>0){ ctx.fillText(line, x, y); y+=lineHeight; line = words[i] + ' '; }
    else line = test;
  }
  ctx.fillText(line, x, y);
}
function drawMultiline(text, x, y, lh){ text.split(/\n/).forEach((ln,i)=> ctx.fillText(ln, x, y + i*lh)); }
function drawDateCard(){
  const r=state.dateCard;
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=16; ctx.shadowOffsetY=6;
  roundedRect(r.x,r.y,r.w,r.h,12); ctx.fillStyle='#262b33'; ctx.fill();
  ctx.shadowBlur=0;
  ctx.fillStyle='#fff'; ctx.textAlign='center';
  ctx.font='700 42px Inter'; ctx.fillText(state.date.title, r.x+r.w/2, r.y+60);
  ctx.font='500 20px Inter'; ctx.globalAlpha=.9; ctx.fillText(state.date.subtitle, r.x+r.w/2, r.y+88);
  ctx.globalAlpha=1; ctx.textAlign='left';
  ctx.restore();
}
function drawStrings(){
  if(!state.stringsOn) return;
  const r=state.dateCard, cx=r.x+r.w/2, cy=r.y+10; // top edge
  ctx.save(); ctx.strokeStyle='#b42323'; ctx.lineWidth=4; ctx.lineCap='round';
  state.notes.forEach(n=>{ const nx=n.x+n.w-20, ny=n.y+20;
    ctx.beginPath(); ctx.moveTo(nx,ny);
    const mx=(nx+cx)/2, my=(ny+cy)/2 - 40;
    ctx.quadraticCurveTo(mx,my,cx,cy);
    ctx.stroke();
  });
  ctx.restore();
}
function drawTasks(){
  const r=state.tasksCard, pad=20, lineH=36, box=22;
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=16; ctx.shadowOffsetY=6;
  roundedRect(r.x,r.y,r.w,r.h,10); ctx.fillStyle='#E9E0C9'; ctx.fill(); ctx.shadowBlur=0;
  drawPin(r.x + r.w/2, r.y - 6);
  let y=r.y+pad+10; ctx.font='24px "Patrick Hand", cursive'; ctx.fillStyle='#222';
  state.tasks.forEach((t,i)=>{
    // big hollow circle
    ctx.lineWidth=3; ctx.strokeStyle='#333'; ctx.beginPath(); ctx.arc(r.x+pad+14, y-8, box/2, 0, TAU); ctx.stroke();
    if(t.done){ ctx.fillStyle='#4ade80'; ctx.beginPath(); ctx.arc(r.x+pad+14, y-8, box/2, 0, TAU); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='bold 20px Inter'; ctx.fillText('âœ“', r.x+pad+6, y-3);
      ctx.font='24px "Patrick Hand", cursive'; ctx.fillStyle='#555'; }
    wrapText(t.text, r.x+pad+40, y, r.w - (pad*2+40), 30);
    y += lineH;
  });
  // button
  ctx.fillStyle='#34d399'; roundedRect(r.x+pad, r.y+r.h-pad-28, 140, 32, 6); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 16px Inter'; ctx.fillText('+ Add Task', r.x+pad+22, r.y+r.h-pad-7);
  ctx.restore();
}
function drawTimer(){
  const r=state.timerRect;
  ctx.save();
  // Panel
  ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=14; ctx.shadowOffsetY=6;
  roundedRect(r.x, r.y, r.w, r.h, 10); ctx.fillStyle='#ffffff'; ctx.fill(); ctx.shadowBlur=0;
  // Header
  ctx.fillStyle='#475569'; ctx.font='600 14px Inter'; ctx.fillText('â±  Timer', r.x+12, r.y+20);
  // Time
  const m=Math.floor(state.timer.seconds/60), s=Math.floor(state.timer.seconds%60);
  ctx.fillStyle='#111827'; ctx.font='bold 28px "Courier New", ui-monospace';
  ctx.fillText(String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'), r.x+12, r.y+56);
  ctx.font='12px Inter'; ctx.fillStyle='#6b7280'; ctx.fillText(state.timer.running?'Observed':'Unobserved (paused)', r.x+12, r.y+72);
  // Buttons stacked
  const btns=[
    {label: state.timer.running?'Stop':'Start', col: state.timer.running?'#ef4444':'#22c55e', x:r.x+12,y:r.y+88,w:r.w-24,h:30, key:'toggle'},
    {label:'Reset', col:'#94a3b8', x:r.x+12,y:r.y+124,w:r.w-24,h:30, key:'reset'}
  ];
  btns.forEach(b=>{ ctx.fillStyle=b.col; roundedRect(b.x,b.y,b.w,b.h,6); ctx.fill();
    ctx.fillStyle='#fff'; ctx.font='bold 14px Inter'; ctx.fillText(b.label, b.x+ (b.w/2-ctx.measureText(b.label).width/2), b.y+20); });
  // Presets grid
  const presets=[1,5,10,15,25]; let px=r.x+12, py=r.y+164;
  presets.forEach((min,i)=>{ const bw= (r.w-24); ctx.fillStyle='#e2e8f0';
    roundedRect(px, py, bw, 26, 6); ctx.fill();
    ctx.fillStyle='#334155'; ctx.font='600 13px Inter'; const t=min+'m';
    ctx.fillText(t, px + (bw/2-ctx.measureText(t).width/2), py+18);
    py+=30;
  });
  // Disclaimer tiny
  ctx.fillStyle='#64748b'; ctx.font='10px Inter';
  ctx.fillText('Advances only while visible.', r.x+12, r.y+r.h-8);
  ctx.restore();
}
function drawFooter(){
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,.65)';
  roundedRect(30,H-38,430,24,6); ctx.fill();
  ctx.fillStyle='#1f2937'; ctx.font='13px Inter';
  ctx.fillText('Reality status: subject to revision. Keep your receipts ðŸ§·', 40, H-21);
  ctx.restore();
}

// ===== Hit tests for widgets
function inside(x,y,rect){ return x>=rect.x && x<=rect.x+rect.w && y>=rect.y && y<=rect.y+rect.h; }
function timerHit(x,y){
  const r=state.timerRect;
  if(!inside(x,y,r)) return {hit:false};
  // toggle/start-stop
  if(inside(x,y,{x:r.x+12,y:r.y+88,w:r.w-24,h:30})) return {hit:true, what:'toggle'};
  if(inside(x,y,{x:r.x+12,y:r.y+124,w:r.w-24,h:30})) return {hit:true, what:'reset'};
  // presets
  const slots=[1,5,10,15,25];
  for(let i=0;i<slots.length;i++){
    const y0=r.y+164+i*30; if(inside(x,y,{x:r.x+12,y:y0,w:r.w-24,h:26})) return {hit:true, what:'preset', minutes:slots[i]};
  }
  return {hit:true, what:'panel'};
}
function tasksHit(x,y){
  const r=state.tasksCard, pad=20, lineH=36, box=22;
  if(!inside(x,y,r)) return null;
  let yy=r.y+pad+10;
  for(let i=0;i<state.tasks.length;i++){
    const bx=r.x+pad, by=yy-22;
    if(inside(x,y,{x:bx, y:by, w:box, h:box})) return {kind:'box', index:i};
    if(inside(x,y,{x:bx+40,y:yy-26,w:r.w-(pad*2+40),h:28})) return {kind:'text', index:i};
    yy+=lineH;
  }
  if(inside(x,y,{x:r.x+pad,y:r.y+r.h-pad-28,w:140,h:32})) return {kind:'add'};
  return null;
}

// ===== Interaction
let draggingId=null, dx=0, dy=0;
const down = isTouch?'touchstart':'mousedown';
const move = isTouch?'touchmove':'mousemove';
const up   = isTouch?'touchend':'mouseup';
function mpos(e){ const rect=canvas.getBoundingClientRect();
  const cx=(e.clientX ?? e.touches?.[0]?.clientX)-rect.left;
  const cy=(e.clientY ?? e.touches?.[0]?.clientY)-rect.top;
  const sx=W/rect.width, sy=H/rect.height; return {x:cx*sx, y:cy*sy}; }
canvas.addEventListener(down, e=>{
  const p=mpos(e);
  // Timer
  const th=timerHit(p.x,p.y);
  if(th.hit){
    if(th.what==='toggle'){ state.timer.running=!state.timer.running; save(); return; }
    if(th.what==='reset'){ state.timer.seconds=5*60; state.timer.running=false; save(); return; }
    if(th.what==='preset'){ state.timer.seconds=th.minutes*60; state.timer.running=false; save(); return; }
    return; // panel click ignored
  }
  // Tasks
  const t=tasksHit(p.x,p.y);
  if(t){
    if(t.kind==='box'){ state.tasks[t.index].done=!state.tasks[t.index].done; save(); return; }
    if(t.kind==='text'){ const txt=prompt('Edit task:', state.tasks[t.index].text); if(txt!==null){ state.tasks[t.index].text=txt; save(); } return; }
    if(t.kind==='add'){ state.tasks.push({text:'New taskâ€¦', done:false}); save(); return; }
  }
  // Notes drag
  for(let i=state.notes.length-1;i>=0;i--){
    const n=state.notes[i];
    if(inside(p.x,p.y,n)){ draggingId=n.id; dx=p.x-n.x; dy=p.y-n.y; state.notes.splice(i,1); state.notes.push(n); return; }
  }
});
canvas.addEventListener(move, e=>{
  if(!draggingId) return;
  const p=mpos(e); const n=state.notes.find(n=>n.id===draggingId); if(!n) return;
  n.x=p.x-dx; n.y=p.y-dy;
});
canvas.addEventListener(up, ()=>{ if(draggingId){ draggingId=null; save(); } });
canvas.addEventListener('dblclick', e=>{
  const p=mpos(e);
  for(let i=state.notes.length-1;i>=0;i--){ const n=state.notes[i];
    if(inside(p.x,p.y,n)){ const t=prompt('Note title (optional):', n.title||''); if(t!==null) n.title=t;
      const c=prompt('Note content:', n.content||''); if(c!==null) n.content=c; save(); return; }
  }
});
canvas.addEventListener('contextmenu', e=>{
  const p=mpos(e); if(timerHit(p.x,p.y).hit){ e.preventDefault(); state.timer.seconds=5*60; state.timer.running=false; save(); }
});

// Visibility = quantum pause
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) state.timer.running=false; });

// ===== Toolbar
document.getElementById('exportPNG').onclick = ()=>{
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = 'quantum_corkboard.png'; a.click();
};

// ===== Loop
let last=performance.now();
function loop(t){
  const dt=(t-last)/1000; last=t;
  if(state.timer.running && !document.hidden){
    state.timer.seconds = Math.max(0, state.timer.seconds-dt);
    if(state.timer.seconds<=0) state.timer.running=false;
  }
  // draw
  cork();
  drawStrings();
  state.notes.forEach(drawNote);
  drawDateCard();
  drawTasks();
  drawTimer();
  drawFooter();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
