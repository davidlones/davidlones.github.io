<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Interactive Star Map</title>
  <style>
    html, body, #root {
      height: 100%;
      margin: 0;
      background: #0b0d16;
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
    }
    body {
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }
    #root {
      width: 100%;
    }
    .boot {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 14px;
      opacity: 0.85;
      pointer-events: none;
      background: radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 55%),
                  radial-gradient(circle at bottom, rgba(0, 200, 255, 0.05), transparent 60%);
    }
  </style>

  <!-- React (UMD) + Babel standalone for on-the-fly JSX -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <div class="boot" id="boot">Loading Interactive Star Map…</div>

  <script>
    (async function () {
      const bootEl = document.getElementById('boot');

      function setBoot(msg) {
        if (bootEl) bootEl.textContent = msg;
      }

      try {
        // Fetch the uploaded JSX as-is
        const resp = await fetch('./interactive_star_map_v_2_react_web_app.jsx', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to fetch JSX: ' + resp.status);
        const src0 = await resp.text();

        // Patch ESM-style imports/exports → globals for UMD runtime
        let src = src0
          .replace(/^\s*import\s+React[^;]*?from\s+["']react["'];?\s*/m,
            "const { useEffect, useMemo, useRef, useState } = React;")
          .replace(/\bexport\s+default\s+function\s+App\s*\(/,
            "function App(");

        // Transpile JSX → JS using Babel Standalone
        const out = Babel.transform(src, { presets: ['react'] }).code;

        // Evaluate in this page's scope.
        // Also expose App and parseFromDatJson on window for our wrapper to use.
        (new Function(out + "\nwindow.__StarMapApp = App; try { window.__parseFromDatJson = parseFromDatJson; } catch(e) {}"))();

        if (!window.__StarMapApp) {
          throw new Error('Star Map App not found after eval');
        }

        // Mount React app
        const rootEl = document.getElementById('root');
        const root = ReactDOM.createRoot(rootEl);
        root.render(React.createElement(window.__StarMapApp));

        // Once it’s mounted, try to auto-load dat.json from the site root.
        // For GitHub Pages at davidlones.github.io, this would be davidlones.github.io/dat.json
        try {
          const datResp = await fetch('./dat.json', { cache: 'no-store' });
          if (datResp.ok) {
            const datObj = await datResp.json();
            if (window.__parseFromDatJson && window.appSetData) {
              const parsed = window.__parseFromDatJson(datObj);
              window.appSetData(parsed);
              console.log('Loaded dat.json →', parsed);
            } else if (window.appSetData) {
              // Fallback: if parser isn’t exposed for some reason, still try to set raw
              console.warn('parseFromDatJson not exposed; appSetData will receive raw dat.json object');
              window.appSetData(datObj);
            }
          } else {
            console.warn('dat.json not found or failed to load:', datResp.status);
          }
        } catch (e) {
          console.warn('Error loading dat.json:', e);
        }

        // Remove boot overlay
        if (bootEl) bootEl.remove();

      } catch (err) {
        console.error(err);
        setBoot('Failed to load the Star Map: ' + (err && err.message ? err.message : err));
      }
    })();
  </script>
</body>
</html>
