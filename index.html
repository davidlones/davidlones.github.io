<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sol-37 • Retro UI</title>
<meta name="color-scheme" content="light">
<style>
  /* --------- Core Reset --------- */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    background: #008080;
    font-family: "MS Sans Serif", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #000;
    overflow: hidden;
    cursor: default;
  }

  /* --------- Window 95 chrome --------- */
  .win95-window {
    position: absolute;
    min-width: 320px;
    min-height: 180px;
    background: #c0c0c0;
    border: 2px solid #fff;
    border-right-color: #404040;
    border-bottom-color: #404040;
    box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf;
    max-width: 100vw;
    max-height: calc(100vh - 32px);
  }
  .titlebar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .5rem;
    background: linear-gradient(#000080, #1084d0);
    color: #fff;
    padding: 2px 6px;
    cursor: move;
    user-select: none;
    font-weight: 700;
    font-size: 13px;
  }
  .titlebar .controls { display: flex; gap: 4px; }
  .titlebar button {
    width: 18px; height: 18px;
    background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080;
    padding: 0; cursor: pointer; line-height: 0;
  }
  .content { padding: 8px; background: #c0c0c0; height: calc(100% - 26px); overflow: auto; }
  .statusbar {
    position: absolute; left: 0; right: 0; bottom: 0;
    height: 18px; background: #c0c0c0; border-top: 1px solid #fff; box-shadow: inset 0 1px 0 #808080;
    font-size: 11px; padding: 2px 6px; display: none;
  }

  /* --------- Taskbar & Start --------- */
  .taskbar {
    position: absolute; left: 0; right: 0; bottom: 0; height: 32px;
    background: #c0c0c0; border-top: 2px solid #fff; box-shadow: inset 0 1px 0 #808080;
    display: grid; grid-template-columns: 108px 1fr 140px; gap: 6px; align-items: center; padding: 3px 6px;
  }
  .start-btn {
    display: inline-flex; align-items: center; gap: 6px; height: 24px; padding: 0 10px; cursor: pointer;
    background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080;
    font-weight: 700;
  }
  .start-menu {
    position: absolute; bottom: 32px; left: 6px; width: 280px; background: #c0c0c0;
    border: 2px solid #fff; border-right-color: #404040; border-bottom-color: #404040;
    box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf;
    display: none;
  }
  .start-menu h4 { margin: 8px; font-size: 13px; }
  .start-menu ul { list-style: none; margin: 0; padding: 0; }
  .start-menu li { display: flex; align-items: center; gap: 8px; padding: 6px 10px; cursor: pointer; }
  .start-menu li:hover { background: #000080; color: #fff; }
  .submenu { margin: 6px 8px 10px; padding: 6px; background:#dfdfdf; border:1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; }
  .submenu h5 { margin: 0 0 6px; font-size: 12px; }
  .submenu .item { padding: 4px 6px; background:#cfcfcf; margin: 2px 0; border:1px solid #808080; cursor:pointer; }
  .submenu .item:hover { background:#000080; color:#fff; }

  .task-buttons { display: flex; gap: 6px; overflow: hidden; }
  .task-button { min-width: 140px; max-width: 220px; height: 24px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; padding: 0 8px; display: inline-flex; align-items: center; background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; cursor: pointer; }
  .task-button.active { outline: 2px solid #000080; color: #000; background: #dfdfdf; }

  .tray { justify-self: end; display: flex; justify-content: flex-end; gap: 6px; align-items: center; }
  #archive-counter {
    display: inline-block;
    font-family: monospace;
    font-size: 11px;
    color: #555;
    opacity: 0.85;
    white-space: nowrap;
    text-decoration: none;
  }
  #archive-counter:hover { text-decoration: underline; }
  .clock { background: #dfdfdf; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; padding: 2px 6px; font-size: 12px; min-width: 110px; text-align: center; }

  /* --------- Icons / Desktop --------- */
  .desktop { position: absolute; inset: 0 0 32px 0; }
  .desktop a.icon {
    position: absolute;
    width: 96px;
    height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
    color: #fff;
    text-decoration: none;
    font-size: 12px;
  }
  .desktop a.icon img { width: 48px; height: 48px; display: block; margin: 0 auto 4px; image-rendering: pixelated; }
  .desktop a.icon span {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    line-height: 14px;
    max-height: 28px;
    overflow: hidden;
    word-break: break-word;
  }

  @media (max-width: 600px) {
    .desktop a.icon { height: 132px; }
  }

  /* --------- Command Prompt --------- */
  .terminal {
    height: 100%; display: grid; grid-template-rows: 1fr auto; background: #000; color: #0f0; font-family: "Lucida Console", "Courier New", monospace; border: 2px solid #000;
  }
  .term-output { padding: 8px; overflow: auto; white-space: pre-wrap; }
  .term-input {
    display: grid; grid-template-columns: auto 1fr; gap: 6px; align-items: center; padding: 6px; background: #111; border-top: 1px solid #0a0;
  }
  .term-input label { color: #0f0; font-size: 12px; }
  .term-input input { background: #000; color: #0f0; border: 1px solid #0a0; padding: 4px 6px; font-family: inherit; }
  .blink { animation: blink 1s steps(1,end) infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  /* --------- Blog window --------- */
  .split { display: grid; grid-template-columns: 220px 1fr; gap: 8px; height: 100%; }
  .panel {
    background: #fff; border: 2px solid #fff; border-right-color: #808080; border-bottom-color: #808080; box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf; overflow: auto;
  }
  .list { list-style: none; margin: 0; padding: 0; }
  .list li { padding: 6px 8px; border-bottom: 1px dashed #c0c0c0; cursor: pointer; font-size: 13px; }
  .list li:hover, .list li.active { background: #000080; color: #fff; }
  .viewer { padding: 10px; font-size: 14px; line-height: 1.35; background: #fff; }
  .viewer h1, .viewer h2, .viewer h3 { margin: .4em 0; }
  .viewer pre { background: #f2f2f2; padding: 6px; overflow: auto; }
  .viewer code { background: #f2f2f2; padding: 1px 3px; }

  /* --------- Document window (iframe) --------- */
  .doc-frame { width: 100%; height: 100%; border: 0; background: #fff; }

  /* --------- Themes --------- */
  .theme-amber .terminal { color: #ffbf00; }
  .theme-amber .term-input label, .theme-amber .term-input input { color: #ffbf00; border-color: #cc9a00; }
  .theme-gray .terminal { color: #d0d0d0; }
  .theme-gray .term-input label, .theme-gray .term-input input { color: #d0d0d0; border-color: #666; }

  /* --------- Utility --------- */
  .hidden { display: none !important; }
  .maximized { left: 0 !important; top: 0 !important; width: 100% !important; height: calc(100% - 32px) !important; }

  @media (max-width: 640px) {
    .win95-window { min-width: auto; min-height: 160px; }
    .desktop a.icon { width: 96px; }
    #archive-counter { max-width: 0; overflow: hidden; opacity: 0; pointer-events: none; }
  }

  @media (prefers-reduced-motion: reduce) { .blink { animation: none; } }

  .desktop      { z-index: 50; }
  .win95-window { z-index: 100; }
  .taskbar      { z-index: 1000; }
  .start-menu   { z-index: 1001; }
</style>
</head>
<body>
  <div class="desktop" id="desktop">
    <a class="icon" style="left:16px; top:16px;" href="#" data-open="about" data-tinylytics-event="desktop.open" data-tinylytics-event-value="about">
      <img alt="My Computer" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='36' y='6' fill='%23c0c0c0' stroke='%23000'/><rect x='4' y='10' width='40' height='24' fill='%23000080'/><rect x='12' y='36' width='24' height='6' fill='%237f7f7f' stroke='%23000'/></svg>">
      <span>Sol-37</span>
    </a>
    <a class="icon" style="left:16px; top:100px;" href="#" data-open="terminal" data-tinylytics-event="desktop.open" data-tinylytics-event-value="terminal">
      <img alt="Command" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='36' y='6' fill='%23000' stroke='%2300ff00'/><text x='8' y='28' font-size='18' fill='%2300ff00' font-family='monospace'>&gt;_</text></svg>">
      <span>Command</span>
    </a>
    <a class="icon" style="left:16px; top:184px;" href="#" data-open="blog" data-tinylytics-event="desktop.open" data-tinylytics-event-value="blog">
      <img alt="Blog" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect x='6' y='8' width='36' height='32' fill='%23fff' stroke='%23000'/><line x1='10' y1='14' x2='38' y2='14' stroke='%23000'/><line x1='10' y1='20' x2='38' y2='20' stroke='%23000'/><line x1='10' y1='26' x2='38' y2='26' stroke='%23000'/><line x1='10' y1='32' x2='28' y2='32' stroke='%23000'/></svg>">
      <span>Blog</span>
    </a>
    <a class="icon" style="left:16px; top:248px;" href="#" data-program="star-map" data-tinylytics-event="desktop.open" data-tinylytics-event-value="star-map">
      <img alt="Star Map" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='48' fill='%23000020'/><circle cx='24' cy='24' r='12' fill='none' stroke='%23ffffff'/><circle cx='24' cy='24' r='2' fill='%23ffd700'/><circle cx='10' cy='11' r='1' fill='%23ffffff'/><circle cx='36' cy='15' r='1' fill='%23ffffff'/><circle cx='14' cy='33' r='1' fill='%23ffffff'/><circle cx='38' cy='35' r='1' fill='%23ffffff'/></svg>">
      <span>Star Map</span>
    </a>
  </div>

  <!-- About Window -->
  <section class="win95-window hidden" id="win-about" style="left: 120px; top: 80px; width: 520px; height: 320px;">
    <div class="titlebar" data-drag-handle>
      <span>About — Sol-37 Retro UI</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <h3>Sol-37</h3>
      <p>
        You’re looking at a Windows-95 echo of myself — a desktop built to explore 
        the archive I’ve been assembling. Every file appearing here is a fragment of the 
        larger story: personal logs, political threads, recovered memories, and the 
        strange physics of a world still reeling from the last few years.
      </p>
      <ul>
        <li><strong>HTML in <code>posts/</code></strong> → becomes desktop icons and windowed files I can open for you.</li>
        <li><strong>Markdown in <code>posts/</code></strong> → streams through the Terminal, indexed under Start → Posts and mirrored in the Blog.</li>
      </ul>
      <p>
        Type <code>posts</code>, <code>openpost &lt;id&gt;</code>, <code>cat &lt;id&gt;</code>, 
        or just click an icon. I’ll guide you. Every command is another step deeper 
        into the timeline.
      </p>
    </div>
    <div class="statusbar" aria-hidden="true">Ready</div>
  </section>

  <!-- Terminal Window -->
  <section class="win95-window hidden" id="win-terminal" style="left: 240px; top: 140px; width: 720px; height: 420px;">
    <div class="titlebar" data-drag-handle>
      <span>Command Prompt — C:\\SOL37\\</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content terminal" id="terminal">
      <div class="term-output" id="term-out"></div>
      <div class="term-input">
        <label for="term-in">C:\\SOL37&gt;</label>
        <input id="term-in" type="text" spellcheck="false" autocomplete="off" placeholder="type a command and press Enter"/>
      </div>
    </div>
  </section>

  <!-- Blog Window -->
  <section class="win95-window hidden" id="win-blog" style="left: 160px; top: 120px; width: 840px; height: 520px;">
    <div class="titlebar" data-drag-handle>
      <span>Blog — C:\\SOL37\\Desktop\\Blog\\</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <div class="split" style="height:100%">
        <aside class="panel" id="posts-list-panel">
          <ul class="list" id="posts-list" aria-label="Posts"></ul>
        </aside>
        <main class="panel viewer" id="post-viewer">
          <h2>Welcome</h2>
          <p>This blog lists files from <code>./posts/index.json</code> or dynamic discovery. Drop a <em>.md</em> here to preview, or use terminal commands.</p>
        </main>
      </div>
    </div>
  </section>

  <!-- Start Menu & Taskbar -->
  <nav class="start-menu" id="start-menu" aria-hidden="true">
    <h4>Sol-37</h4>
    <ul>
      <li data-open="terminal" data-tinylytics-event="menu.open" data-tinylytics-event-value="terminal">Command Prompt</li>
      <li data-open="blog" data-tinylytics-event="menu.open" data-tinylytics-event-value="blog">Blog</li>
      <li data-program="star-map" data-tinylytics-event="menu.launch" data-tinylytics-event-value="star-map">Star Map</li>
      <li data-open="about" data-tinylytics-event="menu.open" data-tinylytics-event-value="about">About all this...</li>
      <li id="menu-theme">Themes ▸</li>
    </ul>
    <div class="submenu" id="menu-posts">
      <h5>Posts</h5>
      <div id="menu-posts-html"></div>
      <div id="menu-posts-md"></div>
    </div>
  </nav>

  <footer class="taskbar" id="taskbar">
    <button class="start-btn" id="start-btn" aria-expanded="false">
      <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><rect width="16" height="16" fill="#008000"></rect><text x="3" y="12" font-size="12" fill="#fff">S</text></svg>
      Start
    </button>
    <div class="task-buttons" id="task-buttons"></div>
    <div class="tray">
      <a id="archive-counter" href="https://tinylytics.app/public/Lq8Z2-ixvVLzYXCEvk9D" target="_blank" rel="noopener noreferrer" title="Open public analytics dashboard (no personal data stored).">
        Archive access: <span class="tinylytics_hits">—</span>
      </a>
      <div class="clock" id="clock">--:-- --</div>
    </div>
  </footer>

<script>
(function(){
  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const PROGRAMS = [
    {
      id: 'star-map',
      title: 'Star Map — StarFinder II',
      file: 'programs/star-map.html',
      width: 900,
      height: 600
    }
  ];
  const WIN_MARGIN_BOTTOM = 32;
  const MOBILE_QUERY = window.matchMedia('(max-width: 640px)');
  const isMobile = () => MOBILE_QUERY.matches;
  
  const trackTinylyticsEvent = (eventName, value) => {
    const probe = document.createElement('button');
    probe.type = 'button';
    probe.style.display = 'none';
    probe.setAttribute('aria-hidden', 'true');
    probe.setAttribute('data-tinylytics-event', eventName);
    if (value != null) probe.setAttribute('data-tinylytics-event-value', String(value));
    document.body.appendChild(probe);
    probe.click();
    probe.remove();
  };

  MOBILE_QUERY.addEventListener?.('change', () => {
    $$('.win95-window, [id^="doc-"]').forEach(clampToViewport);
  });

  const bringToFront = (el) => {
    const maxZ = Math.max(...$$('.win95-window, [id^="doc-"]').map(w => +getComputedStyle(w).zIndex || 10), 10);
    el.style.zIndex = String(maxZ + 1);
  };

  const getTaskButton = (id) => document.querySelector(`.task-button[data-window="${id}"]`);

  const ensureTaskButton = (winEl) => {
    let btn = getTaskButton(winEl.id);
    if (!btn) {
      btn = document.createElement('button');
      btn.className = 'task-button';
      btn.textContent = winEl.querySelector('.titlebar span').textContent;
      btn.dataset.window = winEl.id;
      btn.addEventListener('click', () => toggleWindow(winEl, true));
      $('#task-buttons').appendChild(btn);
    }
    return btn;
  };

  const toggleWindow = (winEl, fromTaskbar = false) => {
    const btn = ensureTaskButton(winEl);

    if (winEl.classList.contains('hidden')) {
      winEl.classList.remove('hidden');
      if (isMobile()) winEl.classList.add('maximized');
      bringToFront(winEl);
      btn.classList.add('active');
      focusFirst(winEl);
      clampToViewport(winEl);
      return;
    }

    // Already visible → bring to front / activate
    bringToFront(winEl);
    $$('.task-button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    clampToViewport(winEl);
  };

  const focusFirst = (win) => {
    const first = win.querySelector('input,button,[tabindex="0"],a,select,textarea');
    if (first) first.focus();
  };

  function clampToViewport(win){
    const r = win.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight - WIN_MARGIN_BOTTOM;

    if (r.width > vw) win.style.width = Math.max(vw, 280) + 'px';
    if (r.height > vh) win.style.height = Math.max(vh, 160) + 'px';

    const rect = win.getBoundingClientRect();
    win.style.left = Math.max(0, Math.min(vw - rect.width, rect.left)) + 'px';
    win.style.top  = Math.max(0, Math.min(vh - rect.height, rect.top)) + 'px';
  }

  window.addEventListener('resize', () => {
    $$('.win95-window, [id^="doc-"]').forEach(clampToViewport);
  });

  // ---------- Wire events for a window (called once when it first becomes visible) ----------
  function wireWindowEvents(win) {
    if (win.dataset.wired) return;
    win.dataset.wired = 'true';

    const handle = win.querySelector('[data-drag-handle]');
    let dragging = false, offX = 0, offY = 0;

    handle.addEventListener('dblclick', () => {
      win.classList.toggle('maximized');
      bringToFront(win);
      clampToViewport(win);
    });

    handle.addEventListener('mousedown', (e) => {
      if (win.classList.contains('maximized')) return;
      dragging = true; bringToFront(win);
      const rect = win.getBoundingClientRect();
      offX = e.clientX - rect.left; offY = e.clientY - rect.top;
      document.body.style.userSelect = 'none';
    });

    const moveHandler = (e) => {
      if (!dragging || win.classList.contains('maximized')) return;
      win.style.left = Math.max(0, Math.min(window.innerWidth - 80, e.clientX - offX)) + 'px';
      win.style.top  = Math.max(0, Math.min(window.innerHeight - 64, e.clientY - offY)) + 'px';
    };
    const upHandler = () => { dragging = false; document.body.style.userSelect = ''; };

    window.addEventListener('mousemove', moveHandler);
    window.addEventListener('mouseup', upHandler);

    win.querySelectorAll('.titlebar [data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.dataset.action;
        trackTinylyticsEvent('window.' + act, win.id.replace(/^win-|^doc-|^prog-/, ''));
        const taskBtn = ensureTaskButton(win);

        if (act === 'close') {
          win.classList.add('hidden');
          taskBtn.remove();
        } else if (act === 'minimize') {
          win.classList.add('hidden');
          taskBtn.classList.remove('active');
        } else if (act === 'maximize') {
          win.classList.toggle('maximized');
          bringToFront(win);
          clampToViewport(win);
          taskBtn.classList.add('active');
        }
      });
    });

    win.addEventListener('mousedown', () => {
      bringToFront(win);
      $$('.task-button').forEach(b => b.classList.remove('active'));
      ensureTaskButton(win).classList.add('active');
    });

    clampToViewport(win);
  }

  // ---------- Boot-time: only clamp hidden windows, no buttons yet ----------
  $$('.win95-window').forEach(win => {
    clampToViewport(win);
  });

  // Desktop icons
  $$('.desktop a.icon').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      if (a.dataset.program) {
        const program = PROGRAMS.find(p => p.id === a.dataset.program);
        if (program) openProgramWindow(program);
        return;
      }

      const map = { about: '#win-about', terminal: '#win-terminal', blog: '#win-blog' };
      const w = $(map[a.dataset.open]);
      if (!w) return;

      if (w.classList.contains('hidden')) {
        w.classList.remove('hidden');
        if (isMobile()) w.classList.add('maximized');
        wireWindowEvents(w);
      }
      toggleWindow(w);
      if (w.id === 'win-terminal') $('#term-in').focus();
    });
  });

  // Start menu
  const startBtn = $('#start-btn');
  const startMenu = $('#start-menu');

  startBtn.addEventListener('click', () => {
    const open = startMenu.style.display === 'block';
    startMenu.style.display = open ? 'none' : 'block';
    startBtn.setAttribute('aria-expanded', String(!open));
  });

  document.addEventListener('click', (e) => {
    if (!startMenu.contains(e.target) && !startBtn.contains(e.target)) {
      startMenu.style.display = 'none';
      startBtn.setAttribute('aria-expanded','false');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      startMenu.style.display = 'none';
      startBtn.setAttribute('aria-expanded','false');
    }
  });

  startMenu.querySelectorAll('[data-open]').forEach(item => {
    item.setAttribute('tabindex','0');
    item.addEventListener('click', () => {
      const map = { about: '#win-about', terminal: '#win-terminal', blog: '#win-blog' };
      const w = $(map[item.dataset.open]);
      if (!w) return;

      if (w.classList.contains('hidden')) {
        w.classList.remove('hidden');
        if (isMobile()) w.classList.add('maximized');
        wireWindowEvents(w);
      }

      toggleWindow(w);
      startMenu.style.display = 'none';
      if (w.id === 'win-terminal') $('#term-in').focus();
    });
  });

  startMenu.querySelectorAll('[data-program]').forEach(item => {
    item.setAttribute('tabindex', '0');
    item.addEventListener('click', () => {
      const program = PROGRAMS.find(p => p.id === item.dataset.program);
      if (program) openProgramWindow(program);
      startMenu.style.display = 'none';
    });
  });

  // Clock
  const clock = $('#clock');
  function updateClock(){
    const d = new Date();
    const hrs = d.getHours();
    const h12 = ((hrs + 11) % 12) + 1;
    const ampm = hrs >= 12 ? 'PM' : 'AM';
    const m = String(d.getMinutes()).padStart(2,'0');
    clock.textContent = `${h12}:${m} ${ampm}`;
  }
  updateClock(); setInterval(updateClock, 1000*15);

  // Tiny Markdown
  function mdToHtml(md){
    let h = String(md ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    h = h.replace(/^(#{1,3})\s?(.*)$/gm,(m,hash,txt)=>`<h${hash.length}>${txt}</h${hash.length}>`)
         .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>')
         .replace(/`([^`]+)`/g,'<code>$1</code>')
         .replace(/\bhttps?:\/\/[^\s)]+/g, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    h = h.split(/\n{2,}/).map(block=>{
      if (/^<h[1-3]>/.test(block)) return block;
      return `<p>${block.replace(/\n/g,'<br>')}</p>`;
    }).join('\n');
    return h;
  }

  // Posts logic (unchanged except integration)
  const postsListEl = $('#posts-list');
  const postViewer = $('#post-viewer');
  const desktop = $('#desktop');
  const menuHtml = $('#menu-posts-html');
  const menuMd = $('#menu-posts-md');

  let POSTS = [];
  let HTML_POSTS = [];
  let MD_POSTS = [];

  async function loadPosts(){
    try{
      const res = await fetch('posts/index.json', {cache:'no-store'});
      if (!res.ok) throw new Error('index not found');
      const data = await res.json();
      POSTS = (data.posts||[]).map(p=>{
        const f = p.file || '';
        const type = f.endsWith('.html') ? 'html' : f.endsWith('.md') ? 'md' : 'other';
        return { id:p.id, title:p.title||p.id, date:p.date||'', file:f, type };
      });
    }catch(e){
      POSTS = [
        {id:'hello-world', title:'Hello World', date:'2025-11-05', file:'posts/hello-world.md', type:'md'}
      ];
    }
    HTML_POSTS = POSTS.filter(p=>p.type==='html');
    MD_POSTS   = POSTS.filter(p=>p.type==='md');

    renderPostsList();
    mountDesktopHtmlIcons();
    buildStartMenuPosts();
  }

  function renderPostsList(){
    postsListEl.innerHTML = '';
    MD_POSTS.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    MD_POSTS.forEach(p=>{
      const li = document.createElement('li');
      li.textContent = `${p.title}${p.date? ' — '+p.date:''}`;
      li.dataset.id = p.id;
      li.setAttribute('data-tinylytics-event', 'post.open');
      li.setAttribute('data-tinylytics-event-value', p.id);
      li.addEventListener('click', ()=> openPost(p.id));
      postsListEl.appendChild(li);
    });
  }

  function mountDesktopHtmlIcons(){
    const startX = 120;
    const startY = 16;
    const stepY  = 84;
    HTML_POSTS.forEach((p, idx)=>{
      const a = document.createElement('a');
      a.className = 'icon';
      a.style.left = startX + 'px';
      a.style.top  = (startY + idx*stepY) + 'px';
      a.href = '#';
      a.dataset.doc = p.id;
      a.title = p.title;
      a.setAttribute('data-tinylytics-event', 'post.open');
      a.setAttribute('data-tinylytics-event-value', p.id);

      const svg = "data:image/svg+xml;utf8," + encodeURIComponent(`<?xml version='1.0'?>
        <svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'>
          <rect x='8' y='6' width='32' height='36' fill='#fff' stroke='#000'/>
          <line x1='12' y1='14' x2='36' y2='14' stroke='#000'/>
          <line x1='12' y1='20' x2='36' y2='20' stroke='#000'/>
          <line x1='12' y1='26' x2='28' y2='26' stroke='#000'/>
        </svg>`);

      const img = document.createElement('img');
      img.alt = 'Document'; img.src = svg;
      const span = document.createElement('span');
      span.textContent = p.title.slice(0,22);

      a.append(img, span);
      a.addEventListener('click', e => {
        e.preventDefault();
        openHtmlDocumentWindow(p);
      });
      desktop.appendChild(a);
    });
  }

  function buildStartMenuPosts(){
    menuHtml.innerHTML = menuMd.innerHTML = '';
    if (HTML_POSTS.length) {
      const h = document.createElement('h5'); h.textContent = 'HTML';
      menuHtml.parentElement.insertBefore(h, menuHtml);
      HTML_POSTS.forEach(p => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = p.title;
        div.setAttribute('data-tinylytics-event', 'post.open');
        div.setAttribute('data-tinylytics-event-value', p.id);
        div.addEventListener('click', () => {
          startMenu.style.display='none';
          openHtmlDocumentWindow(p);
        });
        menuHtml.appendChild(div);
      });
    }
    if (MD_POSTS.length) {
      const h = document.createElement('h5'); h.textContent = 'Markdown';
      menuMd.parentElement.insertBefore(h, menuMd);
      MD_POSTS.forEach(p => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = p.title;
        div.setAttribute('data-tinylytics-event', 'post.open');
        div.setAttribute('data-tinylytics-event-value', p.id);
        div.addEventListener('click', async () => {
          startMenu.style.display='none';
          toggleWindow($('#win-blog'));
          await openPost(p.id);
        });
        menuMd.appendChild(div);
      });
    }
  }

  async function openPost(id){
    const p = MD_POSTS.find(x=>x.id===id); if(!p) return;
    $$('#posts-list li').forEach(li=> li.classList.toggle('active', li.dataset.id===id));
    postViewer.innerHTML = `<h2>${p.title}</h2><p><em>${p.date||''}</em></p><p>Loading…</p>`;
    try{
      const res = await fetch(p.file, {cache:'no-store'});
      const text = await res.text();
      postViewer.innerHTML = mdToHtml(text);
    }catch{
      postViewer.innerHTML = `<p>Could not load <code>${p.file}</code>.</p>`;
    }
  }

  function openHtmlDocumentWindow(p){
    let win = document.getElementById('doc-'+p.id);
    if (!win){
      win = document.createElement('section');
      win.className = 'win95-window';
      win.id = 'doc-'+p.id;

      win.style.left = (180 + Math.floor(Math.random()*60)) + 'px';
      win.style.top  = (100 + Math.floor(Math.random()*40)) + 'px';
      win.style.width = '720px';
      win.style.height = '480px';

      win.innerHTML = `
        <div class="titlebar" data-drag-handle>
          <span>${escapeHtml(p.title)} — C:\\SOL37\\Posts\\</span>
          <div class="controls">
            <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
            <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
            <button title="Close" data-action="close" aria-label="Close">✕</button>
          </div>
        </div>
        <div class="content" style="padding:0">
          <iframe class="doc-frame" src="${p.file}" title="${escapeHtml(p.title)}"></iframe>
        </div>`;

      document.body.appendChild(win);
      wireWindowEvents(win);
    }
    toggleWindow(win);
  }

  function openProgramWindow(prog){
    trackTinylyticsEvent('program.launch', prog.id);
    let win = document.getElementById('prog-' + prog.id);
    if (!win) {
      win = document.createElement('section');
      win.className = 'win95-window';
      win.id = 'prog-' + prog.id;

      win.style.left = '200px';
      win.style.top = '120px';
      win.style.width = (prog.width || 800) + 'px';
      win.style.height = (prog.height || 500) + 'px';

      win.innerHTML = `
        <div class="titlebar" data-drag-handle>
          <span>${escapeHtml(prog.title)} — C:\\SOL37\\Programs\\</span>
          <div class="controls">
            <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
            <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
            <button title="Close" data-action="close" aria-label="Close">✕</button>
          </div>
        </div>
        <div class="content" style="padding:0">
          <iframe class="doc-frame" src="${prog.file}" title="${escapeHtml(prog.title)}" loading="lazy"></iframe>
        </div>`;

      document.body.appendChild(win);
      wireWindowEvents(win);
    }
    toggleWindow(win);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- Terminal ----------
  const out = $('#term-out');
  const input = $('#term-in');
  let history = []; let hIndex = -1;

  function print(txt){ out.innerHTML += txt + "\n"; out.scrollTop = out.scrollHeight; }
  function banner(){ print("Sol-37 Interactive Shell (retro)\nType 'help' to begin.\n"); }
  banner();

  const commands = {
    help(){ print("Available commands:\n  help  about  whoami  date  ls  posts  openpost <id>  cat <id>  star  open <url>  echo  clear  theme <green|amber|gray>"); },
    about(){ print("Sol-37 is your speculative-science sidekick in Win95 clothing."); },
    whoami(){ print("SOL-37 :: Narrator/Assistant :: C:\\\\SOL37>"); },
    date(){ print(new Date().toString()); },
    ls(){ print("DESKTOP\n  - Sol-37\n  - Command\n  - Blog\n  - Star Map\n  - HTML posts (dynamic)"); },
    posts(){ POSTS.forEach(p=> print(` - ${p.id} :: ${p.title}${p.date? ' — '+p.date:''} [${p.type}]`)); },
    async openpost(id){
      if(!id) return print("Usage: openpost <id>");
      const p = POSTS.find(x=>x.id===id);
      if(!p) return print("No such post: "+id);
      if(p.type==='html') openHtmlDocumentWindow(p);
      else if(p.type==='md'){ toggleWindow($('#win-blog')); await openPost(id); }
    },
    async cat(id){
      if(!id) return print("Usage: cat <id>");
      const p = MD_POSTS.find(x=>x.id===id);
      if(!p) return print("No markdown post: "+id);
      try {
        const res = await fetch(p.file, {cache:'no-store'});
        print("\n" + await res.text() + "\n");
      } catch { print('Failed to read post.'); }
    },
    open(arg){
      if(!arg) return print("Usage: open <url>");
      window.open(arg, '_blank', 'noopener');
      print("Opening: " + arg);
    },
    star(){
      openProgramWindow(PROGRAMS.find(p => p.id === 'star-map'));
      print('Launching Star Map...');
    },
    echo(arg){ print(arg||''); },
    clear(){ out.innerHTML = ''; },
    theme(arg){
      document.body.classList.remove('theme-amber','theme-gray');
      if (arg==='amber') document.body.classList.add('theme-amber');
      else if (arg==='gray') document.body.classList.add('theme-gray');
      print("Theme: " + (arg||'green'));
    }
  };

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const raw = input.value.trim();
      if (!raw) return;
      history.unshift(raw); hIndex = -1;
      print(`C:\\SOL37> ${raw}`);
      input.value = '';
      const [cmd, ...rest] = raw.split(/\s+/);
      trackTinylyticsEvent('terminal.command', cmd.toLowerCase());
      const arg = rest.join(' ');
      commands[cmd.toLowerCase()]?.(arg) ?? print(`Unknown command: ${cmd}. Type 'help'.`);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (history.length) {
        hIndex = Math.min(hIndex+1, history.length-1);
        input.value = history[hIndex];
        input.setSelectionRange(input.value.length, input.value.length);
      }
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (history.length) {
        hIndex = Math.max(hIndex-1, -1);
        input.value = hIndex === -1 ? '' : history[hIndex];
      }
    }
  });

  // Boot: auto-open priority post
  loadPosts().then(() => {
    const priority = POSTS.find(x => x.id === 'civSim') || HTML_POSTS[0];
    if (priority) {
      if (priority.type === 'html') {
        openHtmlDocumentWindow(priority);
        const w = $('#doc-' + priority.id);
        if (w && isMobile()) {
          w.classList.add('maximized');
          bringToFront(w);
        }
      } else if (priority.type === 'md') {
        toggleWindow($('#win-blog'));
        openPost(priority.id);
      }
    }
  });

  // Drag-drop md preview
  $('#win-blog').addEventListener('dragover', e => e.preventDefault());
  $('#win-blog').addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files?.[0];
    if (!file || !/\.md$|\.txt$/i.test(file.name)) return alert('Drop a .md or .txt file.');
    const reader = new FileReader();
    reader.onload = () => { postViewer.innerHTML = mdToHtml(reader.result); };
    reader.readAsText(file);
  });

  $('#menu-theme').addEventListener('click', () => {
    toggleWindow($('#win-terminal'));
    print("Try: theme amber | theme gray | theme green");
    startMenu.style.display = 'none';
  });

  $('#win-terminal').addEventListener('click', () => input.focus());
})();
</script>
<script defer src="https://tinylytics.app/embed/BLs8Pz1x77uyP9Ps6uFS.js?hits&events&beacon"></script>
</body>
</html>
