<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sol-37 • Retro UI</title>
<meta name="color-scheme" content="light">
<style>
  /* --------- Core Reset --------- */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    background: #008080; /* Win95 teal */
    font-family: "MS Sans Serif", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #000;
    overflow: hidden;
    cursor: default;
  }

  /* --------- Window 95 chrome --------- */
  .win95-window {
    position: absolute;
    min-width: 320px;
    min-height: 180px;
    background: #c0c0c0;
    border: 2px solid #fff;
    border-right-color: #404040;
    border-bottom-color: #404040;
    box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf;
  }
  .titlebar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .5rem;
    background: linear-gradient(#000080, #1084d0);
    color: #fff;
    padding: 2px 6px;
    cursor: move;
    user-select: none;
    font-weight: 700;
    font-size: 13px;
  }
  .titlebar .controls { display: flex; gap: 4px; }
  .titlebar button {
    width: 18px; height: 18px;
    background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080;
    padding: 0; cursor: pointer; line-height: 0;
  }
  .content { padding: 8px; background: #c0c0c0; height: calc(100% - 26px); overflow: auto; }
  .statusbar {
    position: absolute; left: 0; right: 0; bottom: 0;
    height: 18px; background: #c0c0c0; border-top: 1px solid #fff; box-shadow: inset 0 1px 0 #808080;
    font-size: 11px; padding: 2px 6px; display: none;
  }

  /* --------- Taskbar & Start --------- */
  .taskbar {
    position: absolute; left: 0; right: 0; bottom: 0; height: 32px;
    background: #c0c0c0; border-top: 2px solid #fff; box-shadow: inset 0 1px 0 #808080;
    display: grid; grid-template-columns: 108px 1fr 140px; gap: 6px; align-items: center; padding: 3px 6px;
  }
  .start-btn {
    display: inline-flex; align-items: center; gap: 6px; height: 24px; padding: 0 10px; cursor: pointer;
    background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080;
    font-weight: 700;
  }
  .start-menu {
    position: absolute; bottom: 32px; left: 6px; width: 280px; background: #c0c0c0;
    border: 2px solid #fff; border-right-color: #404040; border-bottom-color: #404040;
    box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf;
    display: none;
  }
  .start-menu h4 { margin: 8px; font-size: 13px; }
  .start-menu ul { list-style: none; margin: 0; padding: 0; }
  .start-menu li { display: flex; align-items: center; gap: 8px; padding: 6px 10px; cursor: pointer; }
  .start-menu li:hover { background: #000080; color: #fff; }
  .submenu { margin: 6px 8px 10px; padding: 6px; background:#dfdfdf; border:1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; }
  .submenu h5 { margin: 0 0 6px; font-size: 12px; }
  .submenu .item { padding: 4px 6px; background:#cfcfcf; margin: 2px 0; border:1px solid #808080; cursor:pointer; }
  .submenu .item:hover { background:#000080; color:#fff; }

  .task-buttons { display: flex; gap: 6px; overflow: hidden; }
  .task-button { min-width: 140px; max-width: 220px; height: 24px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; padding: 0 8px; display: inline-flex; align-items: center; background: #c0c0c0; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; cursor: pointer; }
  .task-button.active { outline: 2px solid #000080; color: #000; background: #dfdfdf; }

  .tray { justify-self: end; display: flex; justify-content: flex-end; gap: 6px; align-items: center; }
  .clock { background: #dfdfdf; border: 1px solid #000; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; padding: 2px 6px; font-size: 12px; min-width: 110px; text-align: center; }

  /* --------- Icons / Desktop --------- */
  .desktop { position: absolute; inset: 0 0 32px 0; }
  .desktop a.icon { position: absolute; width: 88px; text-align: center; color: #fff; text-decoration: none; font-size: 12px; }
  .desktop a.icon img { width: 48px; height: 48px; display: block; margin: 0 auto 4px; image-rendering: pixelated; }

  /* --------- Command Prompt --------- */
  .terminal {
    height: 100%; display: grid; grid-template-rows: 1fr auto; background: #000; color: #0f0; font-family: "Lucida Console", "Courier New", monospace; border: 2px solid #000;
  }
  .term-output { padding: 8px; overflow: auto; white-space: pre-wrap; }
  .term-input {
    display: grid; grid-template-columns: auto 1fr; gap: 6px; align-items: center; padding: 6px; background: #111; border-top: 1px solid #0a0;
  }
  .term-input label { color: #0f0; font-size: 12px; }
  .term-input input { background: #000; color: #0f0; border: 1px solid #0a0; padding: 4px 6px; font-family: inherit; }
  .blink { animation: blink 1s steps(1,end) infinite; }
  @keyframes blink { 50% { opacity: 0; } }

  /* --------- Blog / Files windows --------- */
  .split { display: grid; grid-template-columns: 220px 1fr; gap: 8px; height: 100%; }
  .panel {
    background: #fff; border: 2px solid #fff; border-right-color: #808080; border-bottom-color: #808080; box-shadow: inset -1px -1px 0 #000, inset 1px 1px 0 #dfdfdf; overflow: auto;
  }
  .list { list-style: none; margin: 0; padding: 0; }
  .list li { padding: 6px 8px; border-bottom: 1px dashed #c0c0c0; cursor: pointer; font-size: 13px; }
  .list li:hover, .list li.active { background: #000080; color: #fff; }
  .viewer { padding: 10px; font-size: 14px; line-height: 1.35; background: #fff; }
  .viewer h1, .viewer h2, .viewer h3 { margin: .4em 0; }
  .viewer pre { background: #f2f2f2; padding: 6px; overflow: auto; }
  .viewer code { background: #f2f2f2; padding: 1px 3px; }

  /* --------- Document window (iframe) --------- */
  .doc-frame { width: 100%; height: 100%; border: 0; background: #fff; }

  /* --------- Themes --------- */
  .theme-amber .terminal { color: #ffbf00; }
  .theme-amber .term-input label, .theme-amber .term-input input { color: #ffbf00; border-color: #cc9a00; }
  .theme-gray .terminal { color: #d0d0d0; }
  .theme-gray .term-input label, .theme-gray .term-input input { color: #d0d0d0; border-color: #666; }

  /* --------- Utility --------- */
  .hidden { display: none !important; }
  .maximized { left: 0 !important; top: 0 !important; width: 100% !important; height: calc(100% - 32px) !important; }

  @media (prefers-reduced-motion: reduce) { .blink { animation: none; } }
</style>
</head>
<body>
  <div class="desktop" id="desktop">
    <a class="icon" style="left:16px; top:16px;" href="#" data-open="about">
      <img alt="My Computer" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='36' y='6' fill='%23c0c0c0' stroke='%23000'/><rect x='4' y='10' width='40' height='24' fill='%23000080'/><rect x='12' y='36' width='24' height='6' fill='%237f7f7f' stroke='%23000'/></svg>">
      <span>Sol-37</span>
    </a>
    <a class="icon" style="left:16px; top:100px;" href="#" data-open="terminal">
      <img alt="Command" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='36' y='6' fill='%23000' stroke='%2300ff00'/><text x='8' y='28' font-size='18' fill='%2300ff00' font-family='monospace'>&gt;_</text></svg>">
      <span>Command</span>
    </a>
    <a class="icon" style="left:16px; top:184px;" href="#" data-open="blog">
      <img alt="Blog" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect x='6' y='8' width='36' height='32' fill='%23fff' stroke='%23000'/><line x1='10' y1='14' x2='38' y2='14' stroke='%23000'/><line x1='10' y1='20' x2='38' y2='20' stroke='%23000'/><line x1='10' y1='26' x2='38' y2='26' stroke='%23000'/><line x1='10' y1='32' x2='28' y2='32' stroke='%23000'/></svg>">
      <span>Blog</span>
    </a>
    <a class="icon" style="left:16px; top:268px;" href="#" data-open="files">
      <img alt="Files" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><path d='M6 12h16l4 4h16v20H6z' fill='%23ffdf80' stroke='%23000'/></svg>">
      <span>Files</span>
    </a>
  </div>

  <!-- About Window -->
  <section class="win95-window" id="win-about" style="left: 120px; top: 80px; width: 520px; height: 320px;">
    <div class="titlebar" data-drag-handle>
      <span>About — Sol-37 Retro UI</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <h3>Sol-37</h3>
      <p>Windows-95-styled desktop. Now with dynamic <code>posts/</code> discovery:</p>
      <ul>
        <li><strong>HTML in posts/</strong> → desktop icons + windowed viewer</li>
        <li><strong>Markdown in posts/</strong> → show in Terminal + Start → Posts, view in Blog</li>
      </ul>
      <p>Try <code>posts</code>, <code>openpost &lt;id&gt;</code>, <code>cat &lt;id&gt;</code>, or click icons.</p>
    </div>
    <div class="statusbar" aria-hidden="true">Ready</div>
  </section>

  <!-- Terminal Window -->
  <section class="win95-window" id="win-terminal" style="left: 240px; top: 140px; width: 720px; height: 420px;">
    <div class="titlebar" data-drag-handle>
      <span>Command Prompt — C:\\SOL37\\</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content terminal" id="terminal">
      <div class="term-output" id="term-out"></div>
      <div class="term-input">
        <label for="term-in">C:\\SOL37&gt;</label>
        <input id="term-in" type="text" spellcheck="false" autocomplete="off" placeholder="type a command and press Enter"/>
      </div>
    </div>
  </section>

  <!-- Blog Window -->
  <section class="win95-window hidden" id="win-blog" style="left: 160px; top: 120px; width: 840px; height: 520px;">
    <div class="titlebar" data-drag-handle>
      <span>Blog — C:\\SOL37\\Desktop\\Blog\\</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <div class="split" style="height:100%">
        <aside class="panel" id="posts-list-panel">
          <ul class="list" id="posts-list" aria-label="Posts"></ul>
        </aside>
        <main class="panel viewer" id="post-viewer">
          <h2>Welcome</h2>
          <p>This blog lists files from <code>./posts/index.json</code> or dynamic discovery. Drop a <em>.md</em> here to preview, or use terminal commands.</p>
        </main>
      </div>
    </div>
  </section>

  <!-- Files Window (placeholder) -->
  <section class="win95-window hidden" id="win-files" style="left: 200px; top: 160px; width: 640px; height: 380px;">
    <div class="titlebar" data-drag-handle>
      <span>Files — C:\\SOL37\\Desktop\\Files\\</span>
      <div class="controls">
        <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
        <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
        <button title="Close" data-action="close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="content">
      <p>Place arbitrary assets in <code>files/</code>. Open with <code>open ./files/&lt;name&gt;</code>.</p>
    </div>
  </section>

  <!-- Start Menu & Taskbar -->
  <nav class="start-menu" id="start-menu" aria-hidden="true">
    <h4>Sol-37</h4>
    <ul>
      <li data-open="terminal">Command Prompt</li>
      <li data-open="blog">Blog</li>
      <li data-open="files">Files</li>
      <li data-open="about">About Sol-37</li>
      <li id="menu-theme">Themes ▸</li>
    </ul>
    <div class="submenu" id="menu-posts">
      <h5>Posts</h5>
      <div id="menu-posts-html"></div>
      <div id="menu-posts-md"></div>
    </div>
  </nav>

  <footer class="taskbar" id="taskbar">
    <button class="start-btn" id="start-btn" aria-expanded="false">
      <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true"><rect width="16" height="16" fill="#008000"></rect><text x="3" y="12" font-size="12" fill="#fff">S</text></svg>
      Start
    </button>
    <div class="task-buttons" id="task-buttons"></div>
    <div class="tray">
      <div class="clock" id="clock">--:-- --</div>
    </div>
  </footer>

<script>
(function(){
  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const WIN_MARGIN_BOTTOM = 32; // taskbar height

  const bringToFront = (el) => {
    const maxZ = Math.max( ...$$('.win95-window').map(w => +getComputedStyle(w).zIndex || 10), 10 );
    el.style.zIndex = String(maxZ + 1);
  };

  const createTaskButton = (winEl) => {
    const id = winEl.id;
    const btn = document.createElement('button');
    btn.className = 'task-button';
    btn.textContent = winEl.querySelector('.titlebar span').textContent;
    btn.dataset.window = id;
    btn.addEventListener('click', ()=> toggleWindow(winEl, true));
    return btn;
  };

  const toggleWindow = (winEl, fromTaskbar=false) => {
    if (winEl.classList.contains('hidden')) {
      winEl.classList.remove('hidden');
      bringToFront(winEl);
      const btn = $(`.task-button[data-window="${winEl.id}"]`);
      if (btn) btn.classList.add('active');
      focusFirst(winEl);
    } else if (fromTaskbar) {
      winEl.classList.add('hidden');
      const btn = $(`.task-button[data-window="${winEl.id}"]`);
      if (btn) btn.classList.remove('active');
    } else {
      bringToFront(winEl);
      focusFirst(winEl);
    }
  };

  const focusFirst = (win) => {
    const first = win.querySelector('input,button,[tabindex="0"],a,select,textarea');
    if (first) first.focus();
  };

  function clampToViewport(win){
    const r = win.getBoundingClientRect();
    const maxLeft = Math.max(0, window.innerWidth - Math.min(r.width, window.innerWidth));
    const maxTop  = Math.max(0, window.innerHeight - WIN_MARGIN_BOTTOM - Math.min(r.height, window.innerHeight - WIN_MARGIN_BOTTOM));
    if (r.left > maxLeft) win.style.left = maxLeft + 'px';
    if (r.top  > maxTop) win.style.top  = maxTop  + 'px';
    if (r.left < 0) win.style.left = '0px';
    if (r.top  < 0) win.style.top  = '0px';
  }

  window.addEventListener('resize', ()=> $$('.win95-window').forEach(clampToViewport));

  // ---------- Window wiring ----------
  $$('.win95-window').forEach((win)=>{
    bringToFront(win);
    const tb = createTaskButton(win);
    $('#task-buttons').appendChild(tb);
    // active only if visible at boot
    if (!win.classList.contains('hidden')) tb.classList.add('active');

    const handle = win.querySelector('[data-drag-handle]');
    let dragging = false, offX=0, offY=0;

    handle.addEventListener('dblclick', ()=>{ win.classList.toggle('maximized'); bringToFront(win); });

    handle.addEventListener('mousedown', (e)=>{
      dragging = true; bringToFront(win);
      const rect = win.getBoundingClientRect();
      offX = e.clientX - rect.left; offY = e.clientY - rect.top;
      document.body.style.userSelect = 'none';
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging || win.classList.contains('maximized')) return;
      win.style.left = Math.max(0, Math.min(window.innerWidth - 80, e.clientX - offX)) + 'px';
      win.style.top  = Math.max(0, Math.min(window.innerHeight - 64, e.clientY - offY)) + 'px';
    });
    window.addEventListener('mouseup', ()=>{ dragging = false; document.body.style.userSelect = ''; });

    win.querySelectorAll('.titlebar [data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act = btn.dataset.action;
        if (act === 'close' || act === 'minimize') {
          win.classList.add('hidden');
          const b = $(`.task-button[data-window="${win.id}"]`); if (b) b.classList.remove('active');
        } else if (act === 'maximize') {
          win.classList.toggle('maximized');
          bringToFront(win);
        }
      });
    });

    win.addEventListener('mousedown', ()=>{
      bringToFront(win);
      $$('.task-button').forEach(b=>b.classList.remove('active'));
      const b = $(`.task-button[data-window="${win.id}"]`); if (b) b.classList.add('active');
    });

    clampToViewport(win);
  });

  // Desktop icons open windows
  $$('.desktop a.icon').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const map = { about: '#win-about', terminal: '#win-terminal', blog: '#win-blog', files: '#win-files' };
      const w = $(map[a.dataset.open]); if (!w) return;
      toggleWindow(w);
      if (w.id === 'win-terminal') $('#term-in').focus();
    });
  });

  // Start menu
  const startBtn = $('#start-btn');
  const startMenu = $('#start-menu');
  startBtn.addEventListener('click', ()=>{
    const open = startMenu.style.display === 'block';
    startMenu.style.display = open ? 'none' : 'block';
    startBtn.setAttribute('aria-expanded', String(!open));
    if (!open) startMenu.querySelector('li, .item')?.focus?.();
  });
  document.addEventListener('click', (e)=>{
    if (!startMenu.contains(e.target) && !startBtn.contains(e.target)) {
      startMenu.style.display = 'none'; startBtn.setAttribute('aria-expanded','false');
    }
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') { startMenu.style.display='none'; startBtn.setAttribute('aria-expanded','false'); }
  });
  startMenu.querySelectorAll('[data-open]').forEach(item=>{
    item.setAttribute('tabindex','0');
    item.addEventListener('click', ()=>{
      const map = { about: '#win-about', terminal: '#win-terminal', blog: '#win-blog', files: '#win-files' };
      const w = $(map[item.dataset.open]);
      toggleWindow(w); startMenu.style.display = 'none';
      if (w.id === 'win-terminal') $('#term-in').focus();
    });
  });

  // Clock
  const clock = $('#clock');
  function updateClock(){
    const d = new Date();
    const hrs = d.getHours();
    const h12 = ((hrs + 11) % 12) + 1;
    const ampm = hrs >= 12 ? 'PM' : 'AM';
    const m = String(d.getMinutes()).padStart(2,'0');
    clock.textContent = `${h12}:${m} ${ampm}`;
  }
  updateClock(); setInterval(updateClock, 1000*15);

  // ---------- Tiny Markdown (very small subset) ----------
  function mdToHtml(md){
    let h = String(md ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    h = h.replace(/^(#{1,3})\s?(.*)$/gm,(m,hash,txt)=>`<h${hash.length}>${txt}</h${hash.length}>`)
         .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
         .replace(/\*(.+?)\*/g,'<em>$1</em>')
         .replace(/`([^`]+)`/g,'<code>$1</code>')
         .replace(/\bhttps?:\/\/[^\s)]+/g, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    h = h.split(/\n{2,}/).map(block=>{
      if (/^<h[1-3]>/.test(block)) return block;
      return `<p>${block.replace(/\n/g,'<br>')}</p>`;
    }).join('\n');
    return h;
  }

  // ---------- Posts discovery ----------
  const postsListEl = $('#posts-list');
  const postViewer = $('#post-viewer');
  const desktop = $('#desktop');
  const menuHtml = $('#menu-posts-html');
  const menuMd = $('#menu-posts-md');

  let POSTS = [];      // normalized: {id,title,date,file,type: 'html'|'md'}
  let HTML_POSTS = []; // subset of POSTS
  let MD_POSTS = [];   // subset of POSTS

  async function loadPosts(){
    // Primary: index.json like before
    try{
      const res = await fetch('posts/index.json', {cache:'no-store'});
      if (!res.ok) throw new Error('index not found');
      const data = await res.json();
      POSTS = (data.posts||[]).map(p=>{
        const f = p.file || '';
        const type = f.endsWith('.html') ? 'html' : f.endsWith('.md') ? 'md' : 'other';
        return { id:p.id, title:p.title||p.id, date:p.date||'', file:f, type };
      });
    }catch(e){
      // Fallback: try a lightweight probe of likely files (optional convenience)
      POSTS = [
        {id:'hello-world', title:'Hello World', date:'2025-11-05', file:'posts/hello-world.md', type:'md'}
      ];
    }
    HTML_POSTS = POSTS.filter(p=>p.type==='html');
    MD_POSTS   = POSTS.filter(p=>p.type==='md');

    renderPostsList();
    mountDesktopHtmlIcons();
    buildStartMenuPosts();
  }

  function renderPostsList(){
    postsListEl.innerHTML = '';
    const toShow = MD_POSTS; // Blog lists markdown-focused content
    toShow.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    for(const p of toShow){
      const li = document.createElement('li');
      li.textContent = `${p.title}${p.date? ' — '+p.date:''}`;
      li.dataset.id = p.id; li.title = p.id;
      li.addEventListener('click', ()=> openPost(p.id));
      postsListEl.appendChild(li);
    }
  }

  // Desktop: add icons for HTML posts
  function mountDesktopHtmlIcons(){
    // start placing to the right of default icons
    const startX = 120; // px from left
    const startY = 16;
    const stepY  = 84; // vertical spacing
    HTML_POSTS.forEach((p, idx)=>{
      const a = document.createElement('a');
      a.className = 'icon';
      a.style.left = (startX) + 'px';
      a.style.top  = (startY + idx*stepY) + 'px';
      a.href = '#';
      a.dataset.doc = p.id;
      a.title = p.title;

      // simple document icon
      const svg = "data:image/svg+xml;utf8," +
        encodeURIComponent(`<?xml version='1.0'?>
          <svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'>
            <rect x='8' y='6' width='32' height='36' fill='#fff' stroke='#000'/>
            <line x1='12' y1='14' x2='36' y2='14' stroke='#000'/>
            <line x1='12' y1='20' x2='36' y2='20' stroke='#000'/>
            <line x1='12' y1='26' x2='28' y2='26' stroke='#000'/>
          </svg>`);

      const img = document.createElement('img');
      img.alt = 'Document';
      img.src = svg;
      const span = document.createElement('span');
      span.textContent = p.title.slice(0,22);

      a.appendChild(img); a.appendChild(span);
      a.addEventListener('click', (e)=>{ e.preventDefault(); openHtmlDocumentWindow(p); });
      desktop.appendChild(a);
    });
  }

  // Start menu → Posts (HTML & MD)
  function buildStartMenuPosts(){
    menuHtml.innerHTML = '';
    menuMd.innerHTML = '';
    if (HTML_POSTS.length){
      const h = document.createElement('h5'); h.textContent = 'HTML';
      if (!menuHtml.previousElementSibling || menuHtml.previousElementSibling.tagName!=='H5'){
        menuHtml.parentElement.insertBefore(h, menuHtml);
      }
      HTML_POSTS.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = p.title;
        div.addEventListener('click', ()=>{
          startMenu.style.display='none';
          openHtmlDocumentWindow(p);
        });
        menuHtml.appendChild(div);
      });
    }
    if (MD_POSTS.length){
      const h = document.createElement('h5'); h.textContent = 'Markdown';
      if (!menuMd.previousElementSibling || menuMd.previousElementSibling.tagName!=='H5'){
        menuMd.parentElement.insertBefore(h, menuMd);
      }
      MD_POSTS.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = p.title;
        div.addEventListener('click', async ()=>{
          startMenu.style.display='none';
          toggleWindow($('#win-blog')); await openPost(p.id);
        });
        menuMd.appendChild(div);
      });
    }
  }

  async function openPost(id){
    const p = MD_POSTS.find(x=>x.id===id); if(!p) return;
    $$('#posts-list li').forEach(li=> li.classList.toggle('active', li.dataset.id===id));
    postViewer.innerHTML = `<h2>${p.title}</h2><p><em>${p.date||''}</em></p><p>Loading…</p>`;
    try{
      const res = await fetch(p.file, {cache:'no-store'});
      const text = await res.text();
      if (p.file.endsWith('.md')) postViewer.innerHTML = mdToHtml(text);
      else postViewer.innerHTML = text.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
    }catch(err){
      postViewer.innerHTML = `<p>Could not load <code>${p.file}</code>.</p>`;
    }
  }

  // ---------- Dynamic Document Window (for HTML posts) ----------
  function openHtmlDocumentWindow(p){
    // If already exists, show it
    let win = document.getElementById('doc-'+p.id);
    if (!win){
      win = document.createElement('section');
      win.className = 'win95-window';
      win.id = 'doc-'+p.id;
      win.style.left = (180 + Math.floor(Math.random()*60)) + 'px';
      win.style.top  = (100 + Math.floor(Math.random()*40)) + 'px';
      win.style.width = '720px';
      win.style.height= '480px';
      win.innerHTML = `
        <div class="titlebar" data-drag-handle>
          <span>${escapeHtml(p.title)} — C:\\SOL37\\Posts\\</span>
          <div class="controls">
            <button title="Minimize" data-action="minimize" aria-label="Minimize">_</button>
            <button title="Maximize" data-action="maximize" aria-label="Maximize">▢</button>
            <button title="Close" data-action="close" aria-label="Close">✕</button>
          </div>
        </div>
        <div class="content" style="padding:0">
          <iframe class="doc-frame" src="${p.file}" title="${escapeHtml(p.title)}"></iframe>
        </div>`;
      document.body.appendChild(win);
      wireWindow(win);
    }
    toggleWindow(win);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function wireWindow(win){
    // taskbar btn
    const tb = createTaskButton(win);
    $('#task-buttons').appendChild(tb);
    // drag + controls
    const handle = win.querySelector('[data-drag-handle]');
    let dragging=false, offX=0, offY=0;
    handle.addEventListener('dblclick', ()=>{ win.classList.toggle('maximized'); bringToFront(win); });
    handle.addEventListener('mousedown',(e)=>{
      dragging=true; bringToFront(win);
      const rect = win.getBoundingClientRect();
      offX = e.clientX - rect.left; offY = e.clientY - rect.top;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove',(e)=>{
      if(!dragging || win.classList.contains('maximized')) return;
      win.style.left = Math.max(0, Math.min(window.innerWidth - 80, e.clientX - offX)) + 'px';
      win.style.top  = Math.max(0, Math.min(window.innerHeight - 64, e.clientY - offY)) + 'px';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });

    win.querySelectorAll('.titlebar [data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act = btn.dataset.action;
        if (act === 'close' || act === 'minimize') {
          win.classList.add('hidden');
          const b = $(`.task-button[data-window="${win.id}"]`); if (b) b.classList.remove('active');
        } else if (act === 'maximize') {
          win.classList.toggle('maximized'); bringToFront(win);
        }
      });
    });
    win.addEventListener('mousedown', ()=>{
      bringToFront(win);
      $$('.task-button').forEach(b=>b.classList.remove('active'));
      const b = $(`.task-button[data-window="${win.id}"]`); if (b) b.classList.add('active');
    });
    clampToViewport(win);
  }

  // ---------- Drag-drop .md into viewer (preview only) ----------
  $('#win-blog').addEventListener('dragover', (e)=>{ e.preventDefault(); });
  $('#win-blog').addEventListener('drop', (e)=>{
    e.preventDefault();
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    if (!/\.md$|\.txt$/i.test(file.name)) { alert('Drop a .md or .txt file to preview.'); return; }
    const reader = new FileReader();
    reader.onload = ()=>{ postViewer.innerHTML = mdToHtml(String(reader.result||'')); };
    reader.readAsText(file);
  });

  // ---------- Terminal ----------
  const out = $('#term-out');
  const input = $('#term-in');
  let history = []; let hIndex = -1;

  function print(txt){ out.innerHTML += txt + "\n"; out.scrollTop = out.scrollHeight; }
  function banner(){
    print("Sol-37 Interactive Shell (retro)\nType 'help' to begin.\n");
  }
  banner();

  const commands = {
    help(){
      print(["Available commands:",
        "  help                        Show this help",
        "  about                       About Sol-37",
        "  whoami                      Print identity",
        "  date                        Show local time",
        "  ls                          List desktop items",
        "  posts                       List discovered posts (HTML + MD)",
        "  openpost <id>               Open a post (MD -> Blog, HTML -> window)",
        "  cat <id>                    Print MD post content inline",
        "  open <url|./files/...>      Open a link or local asset",
        "  echo <text>                 Print text",
        "  clear                       Clear screen",
        "  theme <green|amber|gray>    Change terminal theme",
      ].join("\n"));
    },
    about(){ print("Sol-37 is your speculative-science sidekick in Win95 clothing. Drag windows, poke around, and have fun."); },
    whoami(){ print("SOL-37 :: Narrator/Assistant :: C:\\\\SOL37>"); },
    date(){ print(new Date().toString()); },
    ls(){ print("DESKTOP\n  - Sol-37 (About)\n  - Command (Terminal)\n  - Blog (Posts)\n  - Files (Folder)\n  - HTML posts (dynamic icons)"); },
    posts(){
      if (!POSTS.length) { print("No posts found (create posts/index.json). Using demo…"); }
      POSTS.forEach(p=> print(` - ${p.id} :: ${p.title}${p.date? ' — '+p.date:''} [${p.type}]`));
    },
    async openpost(id){
      if(!id){ print("Usage: openpost <id>"); return; }
      const p = POSTS.find(x=>x.id===id);
      if(!p){ print("No such post: "+id); return; }
      if (p.type === 'html'){ openHtmlDocumentWindow(p); }
      else if (p.type === 'md'){ toggleWindow($('#win-blog')); await openPost(id); }
      else { print("Unknown type for: "+id); }
    },
    async cat(id){
      if(!id){ print("Usage: cat <id>"); return; }
      const p = MD_POSTS.find(x=>x.id===id);
      if(!p){ print("No such markdown post: "+id); return; }
      try {
        const res = await fetch(p.file, {cache:'no-store'}); const text = await res.text();
        print("\n"+text+"\n");
      } catch(e){ print('Failed to read post.'); }
    },
    open(arg){
      if (!arg) { print("Usage: open <url|./files/...>"); return; }
      try {
        const w = window.open(arg, '_blank', 'noopener'); 
        if (w) print("Opening: " + arg); else print("Popup blocked.");
      } catch(e){ print("Could not open URL."); }
    },
    echo(arg){ print(arg||''); },
    clear(){ out.innerHTML = ''; },
    theme(arg){
      const b = document.body;
      b.classList.remove('theme-amber','theme-gray');
      if (arg==='amber') b.classList.add('theme-amber');
      else if (arg==='gray') b.classList.add('theme-gray');
      else b.classList.remove('theme-amber','theme-gray');
      print("Theme set: " + (arg||'green'));
    }
  };

  input.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      const raw = input.value.trim();
      if (!raw) return; history.unshift(raw); hIndex = -1;
      print(`C:\\SOL37> ${raw}`);
      input.value='';
      const [cmd, ...rest] = raw.split(/\s+/);
      const arg = rest.join(' ');
      const name = (cmd||'').toLowerCase();
      const fn = commands[name];
      if (fn) fn(arg);
      else print(`Unknown command: ${cmd}. Type 'help'.`);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault(); if (history.length){ hIndex = Math.min(hIndex+1, history.length-1); input.value = history[hIndex]; input.setSelectionRange(input.value.length,input.value.length); }
    } else if (e.key === 'ArrowDown') {
      e.preventDefault(); if (history.length){ hIndex = Math.max(hIndex-1, -1); input.value = hIndex===-1? '': history[hIndex]; }
    }
  });

  // Programmatic openers
  $('#menu-theme').addEventListener('click', ()=>{ toggleWindow($('#win-terminal')); print("Try: theme amber | theme gray | theme green"); startMenu.style.display='none'; });

  $('#task-buttons').addEventListener('click', (e)=>{
    const btn = e.target.closest('.task-button'); if (!btn) return;
    const w = document.getElementById(btn.dataset.window);
    toggleWindow(w, true);
  });

  $('#win-terminal').addEventListener('click', ()=> input.focus());

  // Load posts at boot
  loadPosts();
})();
</script>
</body>
</html>
